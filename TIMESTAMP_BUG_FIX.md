# 緊急バグ修正 v3.2.1

**発見日時**: 2026-02-19 06:45  
**修正完了**: 2026-02-19 06:50  
**重大度**: 🔴 HIGH  

---

## 🐛 発見されたバグ

### 症状
**「締切が過ぎたレースが表示される」**

例:
- 現在時刻: 14:35
- 表示: 10R（締切14:27）← すでに終了しているのに表示される

### 原因

**タイムスタンプのキャッシュ問題**

```javascript
// ❌ 問題のあるコード（修正前）
function getDateInfo() {
    if (cachedDateInfo) return cachedDateInfo;
    
    // ...
    
    cachedDateInfo = { targetDate, showOnlyRace12, now: Date.now() };
    //                                              ^^^^^^^^^^^^^^^^
    //                                              ここでタイムスタンプを固定
    return cachedDateInfo;
}

function selectBestRaceFromSchedule(races, showOnlyRace12) {
    const { now } = getDateInfo(); // ← 古いタイムスタンプを使用
    const upcomingRaces = races.filter(r => r.limitTimestamp > now);
    // ↑ 5分前のタイムスタンプで比較 → 締切が過ぎていても「未到来」と判定
}
```

**具体的な問題**:
1. 14:30にページを開く → `now = 1739946600000`（14:30）がキャッシュされる
2. 14:35になる → キャッシュが残っているため `now` は依然として14:30
3. 10R（締切14:27）と比較 → `14:27 > 14:30`（false）なので除外されるべき
4. しかし、**キャッシュされた14:30で比較** → `14:27 < 14:30`（true）→ 表示される ❌

---

## ✅ 修正内容

### 修正 #1: タイムスタンプキャッシュの削除

```javascript
// ✅ 修正後
function getDateInfo() {
    if (cachedDateInfo) return cachedDateInfo;
    
    // ...
    
    cachedDateInfo = { targetDate, showOnlyRace12 };
    //                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    //                now を削除（日付情報のみキャッシュ）
    return cachedDateInfo;
}
```

### 修正 #2: 毎回タイムスタンプを取得

```javascript
// ✅ 修正後
function selectBestRaceFromSchedule(races, showOnlyRace12) {
    if (showOnlyRace12) {
        // 12R固定の場合
    }
    
    const now = Date.now(); // ← 毎回最新の時刻を取得
    const upcomingRaces = races.filter(r => r.limitTimestamp > now);
    // ↑ 常に最新の時刻で比較
}
```

---

## 📊 修正の効果

### Before（修正前）

| 時刻 | キャッシュされた now | 実際の now | 10R（14:27）の判定 | 結果 |
|------|---------------------|-----------|-------------------|------|
| 14:30 | 14:30 | 14:30 | 14:27 < 14:30 → 除外 | ✅ 正しい |
| 14:35 | 14:30 | 14:35 | 14:27 < 14:30 → 表示 | ❌ バグ |
| 14:40 | 14:30 | 14:40 | 14:27 < 14:30 → 表示 | ❌ バグ |

### After（修正後）

| 時刻 | キャッシュされた now | 実際の now | 10R（14:27）の判定 | 結果 |
|------|---------------------|-----------|-------------------|------|
| 14:30 | - | 14:30 | 14:27 < 14:30 → 除外 | ✅ 正しい |
| 14:35 | - | 14:35 | 14:27 < 14:35 → 除外 | ✅ 正しい |
| 14:40 | - | 14:40 | 14:27 < 14:40 → 除外 | ✅ 正しい |

---

## 🎯 期待される動作

### シナリオ1: レース進行中（14:35）

```javascript
races = [
  { raceNumber: 10, limitTime: "14:27", limitTimestamp: 1739946420000 }, // 終了
  { raceNumber: 11, limitTime: "15:10", limitTimestamp: 1739949000000 }, // 未到来
  { raceNumber: 12, limitTime: "16:00", limitTimestamp: 1739952000000 }  // 未到来
]

now = Date.now() // 14:35 = 1739946900000
upcomingRaces = [11R, 12R] // 10Rは除外される

bestRace = 11R (15:10) ← これが表示される
```

### シナリオ2: 全レース終了（16:30）

```javascript
races = [
  { raceNumber: 10, limitTime: "14:27", limitTimestamp: 1739946420000 },
  { raceNumber: 11, limitTime: "15:10", limitTimestamp: 1739949000000 },
  { raceNumber: 12, limitTime: "16:00", limitTimestamp: 1739952000000 }
]

now = Date.now() // 16:30 = 1739954000000
upcomingRaces = [] // すべて除外

→ 12Rにフォールバック ← これが表示される
```

---

## 🔧 修正されたファイル

1. **js/main.js**
   - `getDateInfo()`: `now` をキャッシュから削除
   - `selectBestRaceFromSchedule()`: `Date.now()` を毎回呼び出し

---

## 📝 その他の関連ドキュメント

### 新規作成

1. **SYSTEM_DESIGN.md**
   - 全体フロー図
   - 時間帯別動作ルール
   - APIリクエスト詳細
   - レース選択ロジック
   - タイムスタンプ処理の詳細説明

### 既存ドキュメント

- **PERFORMANCE_OPTIMIZATION_V3.2.md**: パフォーマンス最適化
- **README.md**: プロジェクト概要

---

## ✅ 動作確認手順

### テスト1: レース進行中

```
1. 現在時刻が 8:00-22:59 の間であることを確認
2. ブラウザで index.html を開く
3. ブラウザのコンソールで実行:
   
   const now = Date.now();
   console.log('現在:', new Date(now).toLocaleTimeString('ja-JP'));
   
4. 各場のレース番号と締切時刻を確認
5. 締切が過ぎたレースが表示されていないことを確認
```

### テスト2: 5分待って再確認

```
1. 5分後に「今すぐ更新」ボタンをクリック
2. レース番号が変わっていることを確認
   （締切が過ぎたレースは次のレースに切り替わる）
```

### テスト3: 全レース終了後

```
1. 18:00以降にアクセス
2. すべての場が12Rを表示していることを確認
3. ラベルが "⏰ 16:00" などの時刻表示になっていることを確認
```

### テスト4: 深夜

```
1. 0:00-7:59にアクセス
2. すべての場が前日の12Rを表示
3. ラベルが "🌙 前日データ" になっていることを確認
```

---

## 🚨 重要な注意点

### キャッシュの使い分け

| 項目 | キャッシュする | 理由 |
|------|---------------|------|
| `targetDate` | ✅ YES | 1回の更新で日付は変わらない |
| `showOnlyRace12` | ✅ YES | 1回の更新でモードは変わらない |
| `now`（現在時刻） | ❌ NO | レース選択時に常に最新が必要 |

### パフォーマンスへの影響

- `Date.now()` の呼び出しコスト: **ほぼゼロ**
- 呼び出し回数: 最大24回（各場1回）
- 影響: **無視できるレベル**

---

## 🎉 完了

- ✅ バグの原因特定
- ✅ 修正コード実装
- ✅ システム設計書作成
- ✅ 修正ドキュメント作成

**次のステップ**:
1. ブラウザで動作確認（Ctrl+Shift+R）
2. 締切前後のレース表示を確認
3. 問題がなければ完了

---

**バージョン**: v3.2.1  
**修正日時**: 2026-02-19 06:50  
**ステータス**: ✅ 修正完了
