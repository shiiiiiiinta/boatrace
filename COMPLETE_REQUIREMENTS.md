# 競艇オッズ表示アプリ - 完全要件定義

## 🎯 基本要件

### 1. 表示対象
- **全24競艇場**のオッズデータを表示
- **複勝オッズ**のみ（1号艇〜6号艇）
- **オッズ範囲**（例: 1.0〜1.5）
- **投票票数と投票金額**

### 2. レース選択ロジック

#### ✅ 深夜時間帯（0:00〜7:59）
```
前日の日付（例: 2/18）でデータ取得
  ↓
レーススケジュールAPIを呼ぶ
  ↓
【開催あり】
  - 全レース終了済み → 12Rを表示
  - 締切時刻を「🌙 前日データ」と表示
  
【開催なし】
  - null を返す
  - 「本日のレース開催はありません」と表示
```

#### ✅ 通常時間帯（8:00〜23:59）
```
今日の日付（例: 2/19）でデータ取得
  ↓
レーススケジュールAPIを呼ぶ
  ↓
【締切前のレースあり】
  - 締切に最も近いレースを選択（例: 9R）
  - 締切時刻を「⏰ HH:MM」形式で表示
  
【全レース終了済み】
  - 12Rを選択
  - 締切時刻を「⏰ HH:MM」形式で表示
  
【開催なし】
  - null を返す
  - 「本日のレース開催はありません」と表示
```

### 3. 表示順序
- **締切時刻が近い順**（昇順）に表示
- 開催がない場は最後尾に表示

### 4. 自動更新
- **8:00〜18:00**: 5分ごとに自動更新
- **それ以外**: 自動更新停止（手動更新のみ）

### 5. メール通知
- 1号艇のオッズが5.0倍を超えた場合、メール送信

---

## 🔍 現在の問題

### 問題1: 宮島（17）、平和島（04）が表示される
**原因**: Worker側が「開催なし」を正しく判定していない可能性

### 問題2: 若松（20）が4Rで止まっている
**原因**: レーススケジュール取得またはレース選択ロジックの不具合

### 問題3: オッズの数値が間違っている
**原因**: Worker側のHTMLパース処理が不正確

---

## ✅ 必要な確認手順

### Step 1: 公式サイトで実データ確認
1. **平和島（04）**: https://www.boatrace.jp/owpc/pc/race/raceindex?jcd=04&hd=20260218
   - 「本日の開催はございません」と表示されるか？
   
2. **宮島（17）**: https://www.boatrace.jp/owpc/pc/race/raceindex?jcd=17&hd=20260218
   - 「本日の開催はございません」と表示されるか？
   
3. **若松（20）**: https://www.boatrace.jp/owpc/pc/race/raceindex?jcd=20&hd=20260218
   - 1R〜12Rが全て表示されるか？
   - 各レースの締切時刻が表示されるか？
   
4. **若松12R**: https://www.boatrace.jp/owpc/pc/race/oddstf?jcd=20&rno=12&hd=20260218
   - 1号艇〜6号艇のオッズが表示されるか？
   - オッズの正確な数値は？

### Step 2: Worker APIのレスポンス確認
```javascript
// レーススケジュール
fetch('https://boatrace.shinta7023.workers.dev/api/race-schedule/04?hd=20260218')

// オッズデータ
fetch('https://boatrace.shinta7023.workers.dev/api/odds/20/12?hd=20260218')
```

### Step 3: フロントエンドのコンソールログ確認
```javascript
// 期待されるログ
"04: Got schedule with 12 races"  // ← 開催ありの場合
"04: No schedule available (no races today)"  // ← 開催なしの場合
"20: Best race is 12R (limit: 16:45)"
```

---

## 🔧 修正方針

### 1. Worker側の修正
- `parseRaceSchedule()`: 開催なしの判定を厳格化
- `parseOddsHtml()`: オッズパース処理の精度向上

### 2. フロントエンド側の修正
- `selectBestRace()`: null判定の確認
- `renderVenueCard()`: 開催なしの表示確認

### 3. テスト
- 各場のデータを個別にテスト
- コンソールログで挙動を確認

---

## 📊 期待される動作（2026-02-19 深夜1:00時点）

| 競艇場 | 2/18開催 | 期待される表示 |
|--------|----------|----------------|
| 桐生（01） | あり | 12R（🌙 前日データ） |
| 戸田（02） | なし | 本日のレース開催はありません |
| 平和島（04） | **なし** | **本日のレース開催はありません** |
| 三国（10） | あり | 12R（🌙 前日データ） |
| 児島（16） | あり | 12R（🌙 前日データ） |
| 宮島（17） | **なし** | **本日のレース開催はありません** |
| 若松（20） | あり | **12R**（🌙 前日データ）← 4Rではない |
| 福岡（22） | あり | 12R（🌙 前日データ） |

---

## 🎯 次のステップ

1. **check-official-site.html** を開いて公式サイトで実データ確認
2. **verify-race-schedule.html** で全24場のスケジュール取得確認
3. Worker側のパース処理を修正
4. フロントエンド側のロジックを修正
5. 再デプロイして動作確認

---

**作成日**: 2026-02-19 02:30  
**目的**: 問題を根本から解決するための完全な要件定義
