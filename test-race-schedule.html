<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç· åˆ‡æ™‚åˆ»ãƒ™ãƒ¼ã‚¹ã®ãƒ¬ãƒ¼ã‚¹é¸æŠãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 { color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        button:hover { transform: translateY(-2px); }
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background: #f5f5f5;
        }
        .success { border-left: 5px solid #4CAF50; }
        .error { border-left: 5px solid #f44336; }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin-top: 10px;
        }
        .venue-test {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .venue-test button {
            font-size: 14px;
            padding: 10px;
        }
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #2196F3;
        }
        .time-info {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #ff9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>â° ç· åˆ‡æ™‚åˆ»ãƒ™ãƒ¼ã‚¹ã®ãƒ¬ãƒ¼ã‚¹é¸æŠãƒ†ã‚¹ãƒˆ</h1>
        <p class="subtitle">BOATRACEå…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰ç· åˆ‡æ™‚åˆ»ã‚’å–å¾—ã—ã€æœ€é©ãªãƒ¬ãƒ¼ã‚¹ã‚’é¸æŠ</p>
        
        <div class="time-info">
            <strong>ç¾åœ¨æ™‚åˆ»:</strong> <span id="currentTime"></span><br>
            <strong>æ—¥ä»˜:</strong> <span id="currentDate"></span>
        </div>
        
        <div class="info-box">
            <strong>ğŸ“Œ ãƒ†ã‚¹ãƒˆå†…å®¹:</strong><br>
            1. Worker ã® `/api/race-schedule/:jcd` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ç· åˆ‡æ™‚åˆ»ã‚’å–å¾—<br>
            2. ç· åˆ‡å‰ã‹ã¤ç· åˆ‡ã«æœ€ã‚‚è¿‘ã„ãƒ¬ãƒ¼ã‚¹ã‚’é¸æŠ<br>
            3. å…¨ãƒ¬ãƒ¼ã‚¹çµ‚äº†ã—ã¦ã„ã‚‹å ´åˆã¯12Rã‚’è¡¨ç¤º
        </div>
        
        <h3>å€‹åˆ¥ä¼šå ´ãƒ†ã‚¹ãƒˆ</h3>
        <button onclick="testVenue('10')">ä¸‰å›½ (10)</button>
        <button onclick="testVenue('01')">æ¡ç”Ÿ (01)</button>
        <button onclick="testVenue('24')">å¤§æ‘ (24)</button>
        
        <h3>å…¨ä¼šå ´ä¸€æ‹¬ãƒ†ã‚¹ãƒˆ</h3>
        <button onclick="testAllVenues()">å…¨24å ´ã®ãƒ¬ãƒ¼ã‚¹é¸æŠã‚’ãƒ†ã‚¹ãƒˆ</button>
        
        <div id="result"></div>
    </div>

    <script>
        const API_BASE = 'https://boatrace.shinta7023.workers.dev';
        
        // ç¾åœ¨æ™‚åˆ»ã‚’è¡¨ç¤º
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('ja-JP');
            document.getElementById('currentDate').textContent = now.toISOString().slice(0, 10).replace(/-/g, '');
        }
        updateTime();
        setInterval(updateTime, 1000);
        
        async function testVenue(jcd) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<p>ãƒ†ã‚¹ãƒˆä¸­...</p>';
            
            try {
                const hd = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                
                // ç· åˆ‡æ™‚åˆ»ã‚’å–å¾—
                const scheduleResponse = await fetch(`${API_BASE}/api/race-schedule/${jcd}?hd=${hd}`);
                const scheduleData = await scheduleResponse.json();
                
                let html = `<h3>ä¼šå ´ã‚³ãƒ¼ãƒ‰: ${jcd}</h3>`;
                html += `<pre>${JSON.stringify(scheduleData, null, 2)}</pre>`;
                
                if (scheduleData.success && scheduleData.data && scheduleData.data.hasSchedule) {
                    const races = scheduleData.data.races;
                    const now = Date.now();
                    
                    html += `<h4>ãƒ¬ãƒ¼ã‚¹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h4>`;
                    html += `<table style="width: 100%; border-collapse: collapse;">`;
                    html += `<tr style="background: #f0f0f0;"><th>ãƒ¬ãƒ¼ã‚¹</th><th>ç· åˆ‡æ™‚åˆ»</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th></tr>`;
                    
                    races.forEach(race => {
                        const isPast = race.limitTimestamp < now;
                        const status = isPast ? 'çµ‚äº†' : 'ç· åˆ‡å‰';
                        const color = isPast ? '#f44336' : '#4CAF50';
                        
                        html += `<tr style="border-bottom: 1px solid #ddd;">`;
                        html += `<td style="padding: 8px;">${race.raceNumber}R</td>`;
                        html += `<td style="padding: 8px;">${race.limitTime}</td>`;
                        html += `<td style="padding: 8px; color: ${color}; font-weight: bold;">${status}</td>`;
                        html += `</tr>`;
                    });
                    
                    html += `</table>`;
                    
                    // ç· åˆ‡å‰ã®ãƒ¬ãƒ¼ã‚¹ã‚’æŠ½å‡º
                    const upcomingRaces = races.filter(r => r.limitTimestamp > now);
                    
                    if (upcomingRaces.length === 0) {
                        html += `<div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px;">`;
                        html += `<strong>ğŸ“Œ é¸æŠçµæœ:</strong> å…¨ãƒ¬ãƒ¼ã‚¹çµ‚äº† â†’ <strong>12R</strong> ã‚’è¡¨ç¤º`;
                        html += `</div>`;
                    } else {
                        const bestRace = upcomingRaces[0];
                        html += `<div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 5px;">`;
                        html += `<strong>ğŸ“Œ é¸æŠçµæœ:</strong> <strong>${bestRace.raceNumber}R</strong> ã‚’è¡¨ç¤º<br>`;
                        html += `ç· åˆ‡æ™‚åˆ»: ${bestRace.limitTime}`;
                        html += `</div>`;
                    }
                    
                    resultDiv.className = 'result success';
                } else {
                    html += `<p style="color: #f44336;">ç· åˆ‡æ™‚åˆ»ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>`;
                    resultDiv.className = 'result error';
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p><pre>${error.stack}</pre>`;
            }
        }
        
        async function testAllVenues() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<p>å…¨24å ´ã‚’ãƒ†ã‚¹ãƒˆä¸­...</p>';
            
            const venues = [
                '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12',
                '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24'
            ];
            
            const venueNames = {
                '01': 'æ¡ç”Ÿ', '02': 'æˆ¸ç”°', '03': 'æ±Ÿæˆ¸å·', '04': 'å¹³å’Œå³¶',
                '05': 'å¤šæ‘©å·', '06': 'æµœåæ¹–', '07': 'è’²éƒ¡', '08': 'å¸¸æ»‘',
                '09': 'æ´¥', '10': 'ä¸‰å›½', '11': 'ã³ã‚ã“', '12': 'ä½ä¹‹æ±Ÿ',
                '13': 'å°¼å´', '14': 'é³´é–€', '15': 'ä¸¸äº€', '16': 'å…å³¶',
                '17': 'å®®å³¶', '18': 'å¾³å±±', '19': 'ä¸‹é–¢', '20': 'è‹¥æ¾',
                '21': 'èŠ¦å±‹', '22': 'ç¦å²¡', '23': 'å”æ´¥', '24': 'å¤§æ‘'
            };
            
            try {
                const hd = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const now = Date.now();
                
                let html = '<h3>å…¨24å ´ã®ãƒ¬ãƒ¼ã‚¹é¸æŠçµæœ</h3>';
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="background: #f0f0f0;"><th>ä¼šå ´</th><th>é¸æŠãƒ¬ãƒ¼ã‚¹</th><th>ç†ç”±</th></tr>';
                
                for (const jcd of venues) {
                    try {
                        const response = await fetch(`${API_BASE}/api/race-schedule/${jcd}?hd=${hd}`);
                        const data = await response.json();
                        
                        let selectedRace = '-';
                        let reason = '-';
                        
                        if (data.success && data.data && data.data.hasSchedule && data.data.races) {
                            const races = data.data.races;
                            const upcomingRaces = races.filter(r => r.limitTimestamp > now);
                            
                            if (upcomingRaces.length === 0) {
                                selectedRace = '12R';
                                reason = 'å…¨ãƒ¬ãƒ¼ã‚¹çµ‚äº†';
                            } else {
                                const bestRace = upcomingRaces[0];
                                selectedRace = `${bestRace.raceNumber}R`;
                                reason = `ç· åˆ‡ ${bestRace.limitTime}`;
                            }
                        } else {
                            reason = 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å–å¾—å¤±æ•—';
                        }
                        
                        html += `<tr style="border-bottom: 1px solid #ddd;">`;
                        html += `<td style="padding: 8px;">${venueNames[jcd]} (${jcd})</td>`;
                        html += `<td style="padding: 8px; font-weight: bold;">${selectedRace}</td>`;
                        html += `<td style="padding: 8px;">${reason}</td>`;
                        html += `</tr>`;
                        
                    } catch (error) {
                        html += `<tr style="border-bottom: 1px solid #ddd;">`;
                        html += `<td style="padding: 8px;">${venueNames[jcd]} (${jcd})</td>`;
                        html += `<td style="padding: 8px; color: #f44336;">ã‚¨ãƒ©ãƒ¼</td>`;
                        html += `<td style="padding: 8px; color: #f44336;">${error.message}</td>`;
                        html += `</tr>`;
                    }
                }
                
                html += '</table>';
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
