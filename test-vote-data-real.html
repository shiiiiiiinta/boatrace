<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BOATRACE API å®Ÿãƒ‡ãƒ¼ã‚¿æ¤œè¨¼</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        pre { background: #2d2d2d; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .section { margin: 20px 0; }
        h2 { color: #4ec9b0; }
        .pass { color: #4ec9b0; }
        .fail { color: #f48771; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ” BOATRACE API å®Ÿãƒ‡ãƒ¼ã‚¿æ¤œè¨¼</h1>
    
    <button onclick="testDirectFetch()">å…¬å¼ã‚µã‚¤ãƒˆã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="testWorkerAPI()">Worker API ãƒ†ã‚¹ãƒˆ</button>
    
    <div class="section">
        <h2>1. å…¬å¼ã‚µã‚¤ãƒˆç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆCORSåˆ¶é™ã‚ã‚Šï¼‰</h2>
        <pre id="directResult">ã¾ã ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“</pre>
    </div>
    
    <div class="section">
        <h2>2. Worker API ãƒ¬ã‚¹ãƒãƒ³ã‚¹</h2>
        <pre id="workerResult">ã¾ã ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“</pre>
    </div>
    
    <div class="section">
        <h2>3. æ¤œè¨¼çµæœ</h2>
        <pre id="validation">ã¾ã ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“</pre>
    </div>

    <script>
        async function testDirectFetch() {
            const result = document.getElementById('directResult');
            result.textContent = 'å–å¾—ä¸­...';
            
            try {
                // ä¸‰å›½12R ã®å…¬å¼URL
                const url = 'https://www.boatrace.jp/owpc/pc/race/oddstf?jcd=10&rno=12&hd=20260218';
                const response = await fetch(url, { mode: 'no-cors' });
                
                result.textContent = 'CORSåˆ¶é™ã«ã‚ˆã‚Šå†…å®¹ã‚’ç¢ºèªã§ãã¾ã›ã‚“ã€‚\n' +
                                   'ãƒ–ãƒ©ã‚¦ã‚¶ã§ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„:\n' + url;
            } catch (error) {
                result.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }
        
        async function testWorkerAPI() {
            const workerResult = document.getElementById('workerResult');
            const validation = document.getElementById('validation');
            
            workerResult.textContent = 'å–å¾—ä¸­...';
            validation.textContent = 'æ¤œè¨¼ä¸­...';
            
            try {
                const response = await fetch('https://boatrace.shinta7023.workers.dev/api/odds/10/12?hd=20260218');
                const data = await response.json();
                
                workerResult.textContent = JSON.stringify(data, null, 2);
                
                // æ¤œè¨¼
                let validationText = '=== æ¤œè¨¼çµæœ ===\n\n';
                
                if (!data.success) {
                    validationText += 'âŒ APIå‘¼ã³å‡ºã—å¤±æ•—\n';
                    validation.textContent = validationText;
                    return;
                }
                
                const responseData = data.data;
                
                if (!responseData || !responseData.odds) {
                    validationText += 'âŒ ã‚ªãƒƒã‚ºãƒ‡ãƒ¼ã‚¿ãªã—\n';
                    validation.textContent = validationText;
                    return;
                }
                
                // ç·æŠ•ç¥¨æ•°ã®ç¢ºèª
                const totalVotes = responseData.odds.reduce((sum, boat) => sum + (boat.voteTickets || 0), 0);
                const totalAmount = responseData.odds.reduce((sum, boat) => sum + (boat.voteAmount || 0), 0);
                
                validationText += `ç·æŠ•ç¥¨æ•°: ${totalVotes} ç¥¨\n`;
                validationText += `æœŸå¾…å€¤: 180 ç¥¨\n`;
                validationText += totalVotes === 180 ? 'âœ… åˆæ ¼\n\n' : 'âŒ ä¸åˆæ ¼\n\n';
                
                validationText += `ç·ç™ºå£²é‡‘é¡: ${totalAmount} å†† (${Math.floor(totalAmount / 100)} ç™¾å††)\n`;
                validationText += `æœŸå¾…å€¤: 18,000 å†† (180 ç™¾å††)\n`;
                validationText += totalAmount === 18000 ? 'âœ… åˆæ ¼\n\n' : 'âŒ ä¸åˆæ ¼\n\n';
                
                validationText += '--- å„è‰‡ã®è©³ç´° ---\n';
                responseData.odds.forEach(boat => {
                    validationText += `${boat.boatNumber}å·è‰‡:\n`;
                    validationText += `  ã‚ªãƒƒã‚º: ${boat.oddsMin || boat.odds} - ${boat.oddsMax || boat.odds}\n`;
                    validationText += `  ç¥¨æ•°: ${boat.voteTickets || 0}\n`;
                    validationText += `  é‡‘é¡: ${boat.voteAmount || 0} å††\n\n`;
                });
                
                // åˆ¤å®š
                if (totalVotes === 0 && totalAmount === 0) {
                    validationText += '\nğŸ”´ çµè«–: Worker ã¯ç¥¨æ•°ãƒ»é‡‘é¡ã‚’å…¨ãå–å¾—ã§ãã¦ã„ã¾ã›ã‚“\n';
                    validationText += '\nåŸå› : BOATRACEå…¬å¼ã‚µã‚¤ãƒˆã®HTMLæ§‹é€ ãŒæƒ³å®šã¨ç•°ãªã‚‹ã€\n';
                    validationText += 'ã¾ãŸã¯å…¬å¼ã‚µã‚¤ãƒˆãŒè¤‡å‹ã®ç¥¨æ•°ãƒ»é‡‘é¡ãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n';
                    validationText += '\nå¯¾å¿œ: å…¬å¼ã‚µã‚¤ãƒˆã®HTMLã‚’ç›´æ¥ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚';
                } else if (totalVotes !== 180 || totalAmount !== 18000) {
                    validationText += '\nğŸŸ¡ çµè«–: Worker ã¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™ãŒã€å€¤ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“\n';
                    validationText += '\nãƒ‘ãƒ¼ã‚¹å‡¦ç†ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚';
                } else {
                    validationText += '\nğŸŸ¢ çµè«–: å®Œç’§ã§ã™ï¼å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå–å¾—ã§ãã¦ã„ã¾ã™ã€‚';
                }
                
                validation.textContent = validationText;
                console.log('Full data:', data);
                
            } catch (error) {
                workerResult.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}\n${error.stack}`;
                validation.textContent = `æ¤œè¨¼å¤±æ•—: ${error.message}`;
            }
        }
        
        // è‡ªå‹•å®Ÿè¡Œ
        window.addEventListener('load', () => {
            testWorkerAPI();
        });
    </script>
</body>
</html>
