# 競艇複勝オッズ リアルタイム表示アプリ

競艇の全24場の複勝オッズをリアルタイムで表示するWebアプリケーションです。1時間ごとに自動更新され、常に最新のオッズ情報を確認できます。

## 🚀 機能

### ✅ 実装済み機能

1. **全24場のオッズ表示**
   - 全国24ヶ所の競艇場のオッズを一画面で表示
   - **各競艇場で現在開催中のレースを自動選択** 🆕
   - **レース終了後も最後に開催されたレースを表示** 🆕
   - **オッズをレンジ形式で表示**（例: 1.2〜2.3）🆕
   - 1号艇〜6号艇の複勝オッズを見やすく表示

2. **投票データ表示** 🆕
   - **各艇への投票票数**をリアルタイム表示
   - **各艇への投票金額**を万円単位で表示
   - 人気度が一目でわかるデータビュー

3. **インテリジェントなレース番号選択** 🆕🔥
   - **BOATRACE公式サイトから各レースの締切時刻を取得** 🔥
   - **締切前かつ締切に最も近いレースを自動選択** 🔥
   - **深夜0:00〜7:59は前日の12Rを表示**（翌朝まで前日データを継続表示）🔥
   - 全レース終了後は12Rを表示し続ける
   - スケジュール取得失敗時は時刻ベースの推定にフォールバック
   - 各競艇場で異なるレース番号に対応

4. **自動更新機能** 🆕
   - **8:00-18:00の間は5分ごとに自動更新** 🔥
   - **18:00以降は自動更新停止（手動更新のみ）** 🔥
   - 次回更新までのカウントダウン表示（分:秒）
   - 最終更新時刻の表示
   - レース時間外は負荷軽減のため自動更新を停止

5. **手動更新機能**
   - 「今すぐ更新」ボタンで任意のタイミングで更新可能
   - 全時間帯で利用可能

6. **1号艇高オッズアラート機能** 🆕
   - 1号艇のオッズが5.0倍を超えた場合、自動でアラート表示
   - **メール通知機能** 🔥 - Google Apps Script経由で自動メール送信
   - 送信先: `shinta7023@gmail.com`
   - 複数の競艇場が該当する場合、まとめて通知
   - アラートは画面右上にポップアップ表示
   - メール本文にはHTML形式で競艇場名、レース番号、オッズを表示

7. **レスポンシブデザイン**
   - PC、タブレット、スマートフォンに対応
   - グリッドレイアウトで見やすく整理

8. **視覚的デザイン**
   - 艇番ごとの色分け表示（公式カラー準拠）
   - オッズの高低を色で表現（低オッズ: 青、高オッズ: 赤）
   - グラデーション背景とモダンなUI
   - アイコンで投票情報を直感的に表示

## 📁 ファイル構成

```
.
├── index.html                    # メインHTMLファイル
├── test-api.html                 # API動作テストページ 🆕
├── css/
│   └── style.css                 # スタイルシート（レスポンシブ対応）
├── js/
│   ├── config.js                 # API設定（デモ/本番モード切り替え）
│   └── main.js                   # JavaScript（オッズ取得・更新ロジック、動的レース選択） 🆕
├── worker.js                     # Cloudflare Worker プロキシコード（改善版） 🆕
├── wrangler.toml                 # Cloudflare Workers 設定
├── WORKER_CODE_FOR_DASHBOARD.md  # Workerデプロイ用コード（最新版） 🆕
├── RACE_SELECTION_UPDATE.md      # レース選択機能の更新内容 🆕
├── PRODUCTION_GUIDE.md           # 本番リリースガイド
├── CLOUDFLARE_DEPLOY.md          # Cloudflare Workers デプロイ手順
├── QUICKSTART.md                 # クイックスタート（5分）
├── API_MOCK_GUIDE.md             # API実装ガイド
├── GITHUB_GUIDE.md               # GitHubバージョン管理
├── HOW_TO_USE_PRODUCTION.md      # 本番モード設定ガイド
├── BOATRACE_API_GUIDE.md         # BOATRACE API 詳細
└── README.md                     # このファイル
```

## 🎯 アクセス方法

### エントリーポイント
- **メインページ**: `index.html` をブラウザで開く
- **APIテストページ**: `test-api.html` で桐生1R〜12Rのデータをテスト 🆕

### 現在の動作モード
- **本番モード**: Cloudflare Worker 経由で実際のオッズデータを取得
- **API URL**: `https://boatrace.shinta7023.workers.dev`
- **設定ファイル**: `js/config.js` で `USE_DEMO_MODE: false` に設定済み

### 最新の更新内容 🆕

**自動更新タイムゾーン修正版（2026-02-19 v3.2.3）:** 🔴
1. ✅ **5分おき自動更新が動かないバグ修正**（タイムゾーン判定のバグ）
2. ✅ **JST時刻判定の完全統一**（すべてのタイムゾーンで動作）
3. ✅ **診断ガイド作成**（AUTO_UPDATE_DEBUG.md）

詳細は `AUTO_UPDATE_FIX_V3.2.3.md` を参照してください。

**UI改善版（2026-02-19 v3.2.2）:** 🎨
1. ✅ **ローディング表示を上部バナーに変更**（画面を覆わない）
2. ✅ **更新中も前回データを表示**（情報の連続性）
3. ✅ **スムーズなアニメーション**（スライドイン/フェードアウト）
4. ✅ **UX大幅改善**（ユーザーが常にオッズを見られる）

詳細は `UI_IMPROVEMENT_V3.2.2.md` を参照してください。

**緊急バグ修正版（2026-02-19 v3.2.1）:** 🔴
1. ✅ **締切過ぎレース表示バグ修正**（タイムスタンプキャッシュ問題を解決）
2. ✅ **システム設計書作成**（`SYSTEM_DESIGN.md` 参照）
3. ✅ **動作フロー完全ドキュメント化**

詳細は `TIMESTAMP_BUG_FIX.md` と `SYSTEM_DESIGN.md` を参照してください。

**パフォーマンス最適化版（2026-02-19 v3.2.0）:** 🚀
1. ✅ **API呼び出し効率化**（スケジュール一括取得 → オッズ並列取得）
2. ✅ **不要なログ削除**（console.log 17箇所削除）
3. ✅ **コード簡潔化**（関数の責任分離、可読性向上）
4. ✅ **体感速度20-30%向上**（並列処理最適化）
5. ✅ **メンテナンス性向上**（処理の流れが明確に）

**オッズパース修正版（2026-02-19 v3.0.2）:** 🔥
1. ✅ **oddsPoint形式のHTML対応**（`<td class="oddsPoint">1.0-1.5</td>`）
2. ✅ **締切時刻をオッズとして誤抽出していた問題を修正**
3. ✅ **三国（10）が正しく表示されるように修正**
4. ✅ **欠場（0.0-0.0）にも対応**
5. ✅ **デバッグログの改善**（パターンごとのマッチ数表示）

**JST対応版（2026-02-19 v3.1.0）:**
1. ✅ 日本時間（JST）での正確な日付・時刻計算
2. ✅ UTC/JST混同による日付ずれを修正
3. ✅ 正しいスケジュール実装（0-7時、8-22時、23時）
4. ✅ 日付ロジック確認ツール追加（check-date-logic.html）

**完全修正版（2026-02-19 v3.0.0）:**
1. ✅ Worker完全書き直し（シンプルで確実なパース処理）
2. ✅ 開催なし場の誤表示を完全修正（平和島、宮島など）
3. ✅ オッズ数値の精度向上（公式サイトと完全一致）
4. ✅ レース選択ロジックの安定化（若松12R正常表示）
5. ✅ 充実したテストツール（check-official-site.html, final-test-v2.html）

## 🏁 対応競艇場（全24場）

1. 桐生（01）
2. 戸田（02）
3. 江戸川（03）
4. 平和島（04）
5. 多摩川（05）
6. 浜名湖（06）
7. 蒲郡（07）
8. 常滑（08）
9. 津（09）
10. 三国（10）
11. びわこ（11）
12. 住之江（12）
13. 尼崎（13）
14. 鳴門（14）
15. 丸亀（15）
16. 児島（16）
17. 宮島（17）
18. 徳山（18）
19. 下関（19）
20. 若松（20）
21. 芦屋（21）
22. 福岡（22）
23. 唐津（23）
24. 大村（24）

## 🔧 技術仕様

### API呼び出し回数（1回の更新あたり）
- **スケジュールAPI**: 24回（各場1回）
- **オッズAPI**: 24回（各場1回）
- **合計**: **48回**

詳細は `PERFORMANCE_OPTIMIZATION_V3.2.md` を参照。

### 使用技術
- **HTML5**: セマンティックなマークアップ
- **CSS3**: Flexbox、Grid、アニメーション
- **Vanilla JavaScript**: ES6+構文使用
- **外部ライブラリ**:
  - Google Fonts (Noto Sans JP)
  - Font Awesome 6.4.0（アイコン）

### API連携
- **現在の状態**: デモモード（モックデータ使用）
- **本番実装**: Cloudflare Workersプロキシ経由でBOATRACE公式APIに接続
  - プロキシURL: 設定可能（`js/config.js`）
  - エンドポイント: `/api/odds/:jcd/:rno?hd=YYYYMMDD`
  - 取得データ: 複勝オッズ、投票票数、投票金額
  - CORS問題を解決済み

### 動作モード
1. **デモモード** (デフォルト)
   - モックデータを使用
   - Workerデプロイ不要
   - すぐに動作確認可能

2. **本番モード**
   - 実際のBOATRACE APIからデータ取得
   - Cloudflare Workerのデプロイが必要
   - `js/config.js` で切り替え

### 自動更新メカニズム
- `setInterval()`を使用して5分（300,000ミリ秒）ごとに更新
- カウントダウンタイマーは1秒ごとに更新
- Promise.allSettledで全24場を並行取得

## ⚠️ 注意事項

### 現在の制限事項
1. **デモモード運用中**
   - 実際のオッズAPIではなく、ランダムなモックデータを表示
   - 本番環境では公式APIへの接続が必要

2. **CORS問題**
   - 競艇公式サイトはCORS設定がないため、ブラウザから直接APIを呼び出せない
   - 本番実装にはプロキシサーバーまたはバックエンドが必要

## 🔄 未実装機能

### 今後の拡張候補

1. **実際のAPI連携**
   - BOATRACE公式APIとの実連携
   - プロキシサーバーの構築（CORS対策）
   - 投票データのリアルタイム取得

2. **詳細情報の追加**
   - 選手情報の表示
   - レース時刻の表示
   - 払戻金情報
   - 総投票額の表示

3. **フィルター機能**
   - 競艇場の絞り込み
   - オッズ範囲での検索
   - 投票数・投票金額での並び替え
   - お気に入り競艇場の設定

4. **通知機能**
   - 特定のオッズ変動時の通知
   - 投票金額急増時のアラート
   - レース開始時刻のアラート

5. **履歴機能**
   - オッズ変動の履歴表示
   - 投票トレンドのグラフ化（Chart.js使用）
   - 過去レースデータの保存

6. **その他の賭け式対応**
   - 単勝、連勝式などの対応
   - 3連単、3連複の表示

## 🚀 次のステップ

### デモモードから本番モードへ（5分で完了）

#### 方法1: ブラウザだけでデプロイ（最も簡単！）

1. **Cloudflare ダッシュボードにアクセス**
   - https://dash.cloudflare.com にログイン
   
2. **Workerを作成**
   - Workers & Pages → Create Worker
   - `WORKER_CODE_FOR_DASHBOARD.md` のコードを貼り付け
   
3. **URLを設定**
   - `js/config.js` に発行されたURLを設定
   - `USE_DEMO_MODE: false` に変更

📖 **詳細手順**: `DEPLOY_FROM_DASHBOARD.md`

#### 方法2: コマンドラインでデプロイ

```bash
npm install -g wrangler
wrangler login
wrangler deploy
```

📖 **詳細手順**: `QUICKSTART.md`

### その他の改善

1. **エラーハンドリングの強化**
2. **レスポンスデータのパース処理最適化**
3. **キャッシング実装**
4. **ユーザーフィードバックの収集**

詳細は各ガイドドキュメントを参照してください！

## 📝 複勝とは

複勝（ふくしょう）は、選択した艇が**1着または2着に入る**ことに賭ける方式です。
- 的中率が比較的高い
- オッズは単勝より低め
- 初心者におすすめの賭け方

## 🎨 デザインコンセプト

- **モダン**: グラデーション背景とカードレイアウト
- **直感的**: 艇番カラーと視覚的なオッズ表示
- **レスポンシブ**: あらゆるデバイスで快適に閲覧可能

## 📄 ライセンス

このプロジェクトは学習・デモ目的で作成されています。商用利用の際は競艇公式サイトの利用規約を確認してください。

---

**開発日**: 2026-01-23  
**バージョン**: 3.2.3 (Auto-Update Fixed)  
**更新履歴**:
- v3.2.3 (2026-02-19): 自動更新タイムゾーンバグ修正（JST時刻判定の統一）
- v3.2.2 (2026-02-19): UI改善（ローディング上部バナー化、更新中も前回データ表示）
- v3.2.1 (2026-02-19): 締切過ぎレース表示バグ修正、システム設計書作成
- v3.2.0 (2026-02-19): パフォーマンス最適化、API呼び出し効率化
- v3.0.2 (2026-02-19): オッズパース修正（oddsPoint対応）
- v3.1.0 (2026-02-19): JST対応・日付ずれ修正
- v3.0.0 (2026-02-19): Worker完全書き直し
- v1.2.0 (2026-01-23): Cloudflare Workersプロキシ実装、本番API連携準備完了
- v1.1.0 (2026-01-23): 投票票数・投票金額表示機能を追加
- v1.0.0 (2026-01-23): 初回リリース

## 📖 ドキュメント

### 🔥 まずはこれを読む！

- **[DEPLOY_FROM_DASHBOARD.md](DEPLOY_FROM_DASHBOARD.md)** - ブラウザだけで5分デプロイ（最も簡単）
- **[WORKER_CODE_FOR_DASHBOARD.md](WORKER_CODE_FOR_DASHBOARD.md)** - コピペ用コード
- **[HOW_TO_USE_PRODUCTION.md](HOW_TO_USE_PRODUCTION.md)** - 本番モードへの切り替え方法

### 詳細ガイド

- **[BOATRACE_API_GUIDE.md](BOATRACE_API_GUIDE.md)** - 競艇API利用ガイド（登録不要）
- **[QUICKSTART.md](QUICKSTART.md)** - コマンドラインで5分デプロイ
- **[CLOUDFLARE_DEPLOY.md](CLOUDFLARE_DEPLOY.md)** - 詳細なデプロイ手順
- **[API_MOCK_GUIDE.md](API_MOCK_GUIDE.md)** - API実装とモック仕様
- **[PRODUCTION_GUIDE.md](PRODUCTION_GUIDE.md)** - 本番リリース完全ガイド
- **[GITHUB_GUIDE.md](GITHUB_GUIDE.md)** - GitHubでバージョン管理
