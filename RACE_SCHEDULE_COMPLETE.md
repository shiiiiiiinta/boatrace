# 🎉 締切時刻ベースのレース選択機能 実装完了

## ✅ 実装内容

### 要件
> 最優先は、各場で、締切前かつ締切に最も近いレースの表示です。
> レースがすべて終わってる場は、次の日の朝まで前日12rのオッズ表示をしてください

### 実装内容

#### 1. Worker: 締切時刻取得エンドポイント
**ファイル**: `worker.js`

**新しいエンドポイント**:
```
GET /api/race-schedule/:jcd?hd=YYYYMMDD
```

**機能**:
- BOATRACE公式サイト（`raceindex`ページ）から各レースの締切時刻を取得
- HTMLをパースして1R〜12Rの締切時刻を抽出
- タイムスタンプに変換して返却

**レスポンス例**:
```json
{
  "success": true,
  "data": {
    "jcd": "10",
    "date": "20260218",
    "hasSchedule": true,
    "races": [
      {
        "raceNumber": 1,
        "limitTime": "08:47",
        "limitTimestamp": 1739838420000
      },
      {
        "raceNumber": 2,
        "limitTime": "09:17",
        "limitTimestamp": 1739840220000
      },
      ...
    ],
    "timestamp": "2026-02-18T23:15:00.000Z"
  }
}
```

#### 2. フロントエンド: レース選択ロジック改善
**ファイル**: `js/main.js`

**新しい関数**:
- `selectBestRace(jcd, hd)` - 締切時刻に基づいて最適なレースを選択
- `selectBestRaceFallback()` - スケジュール取得失敗時のフォールバック

**動作**:
1. Worker から締切時刻を取得
2. 現在時刻と比較
3. 締切前のレースを抽出
4. 締切に最も近いレースを選択
5. 全レース終了している場合は **12R** を返す

**ロジック**:
```javascript
// 締切前のレースを抽出
const upcomingRaces = races.filter(r => r.limitTimestamp > now);

if (upcomingRaces.length === 0) {
    // 全レース終了 → 12Rを返す
    return 12;
}

// 締切に最も近いレース
upcomingRaces.sort((a, b) => a.limitTimestamp - b.limitTimestamp);
return upcomingRaces[0].raceNumber;
```

---

## 🧪 テスト方法

### テスト1: 締切時刻取得のテスト

`test-race-schedule.html` をブラウザで開く：

1. **個別会場テスト**
   - 「三国 (10)」ボタンをクリック
   - 1R〜12Rの締切時刻一覧が表示される
   - 選択されたレース番号が表示される

2. **全会場一括テスト**
   - 「全24場のレース選択をテスト」ボタンをクリック
   - 全24場の選択レースと理由が一覧表示される

### テスト2: 実際のアプリでの動作確認

1. Worker を再デプロイ
2. `index.html` を開く
3. 各競艇場のカードに表示されるレース番号を確認
4. コンソール（F12）で以下のログを確認：
   ```
   10: Got schedule with 12 races
   10: Best race is 8R (limit: 14:30)
   10: Selected race 8R (based on limit times)
   ```

---

## 🚀 デプロイ手順

### ステップ1: Worker を再デプロイ

1. https://dash.cloudflare.com/ にログイン
2. Workers & Pages → `boatrace` → Edit code
3. 既存コード全削除
4. プロジェクトの `worker.js` の内容を全て貼り付け
5. **Save and Deploy**

### ステップ2: フロントエンドファイルの確認

以下のファイルが更新されています：
- ✅ `worker.js` - 締切時刻取得エンドポイント追加
- ✅ `js/main.js` - レース選択ロジック完全書き換え
- ✅ `test-race-schedule.html` - テストページ作成
- ✅ `README.md` - 機能説明更新

---

## 📋 動作確認チェックリスト

### Worker
- [ ] Worker 再デプロイ完了
- [ ] `https://boatrace.shinta7023.workers.dev/` でversion確認（2.2.0-with-schedule）
- [ ] `/api/race-schedule/10?hd=20260218` で締切時刻取得成功

### フロントエンド
- [ ] `test-race-schedule.html` で締切時刻一覧表示成功
- [ ] 締切前のレースが正しく選択される
- [ ] 全レース終了時は12Rが選択される

### 実際のアプリ
- [ ] `index.html` で各競艇場に適切なレースが表示される
- [ ] レース中（例: 14:00）→ 締切直前のレースが表示
- [ ] レース終了後（例: 18:00以降）→ 全場で12Rが表示

---

## 🎯 実装の特徴

### 利点
1. **正確なレース選択**: 公式サイトの締切時刻を使用
2. **リアルタイム性**: 締切直前のレースを確実に表示
3. **フォールバック機能**: API取得失敗時も動作
4. **全レース終了対応**: 18:00以降も前日12Rを表示

### HTMLパース処理
```html
<!-- 公式サイトのHTML構造 -->
<td class="is-fs14 is-fBold"><a href="...">1R</a></td>
<td>08:47</td>
<td class="is-fBold is-fColor2">発売終了</td>
```

正規表現パターン:
```javascript
/<td[^>]*class="[^"]*is-fs14[^"]*"[^>]*><a[^>]*>(\d+)R<\/a>\s*<\/td>\s*<td>(\d{2}:\d{2})<\/td>/gi
```

---

## 📝 動作例

### 例1: レース中（14:30の場合）

**三国競艇場のスケジュール**:
```
1R: 08:47 (終了)
2R: 09:17 (終了)
...
8R: 14:25 (終了)
9R: 14:55 (締切前) ← 選択
10R: 15:25 (締切前)
...
```

**結果**: 9R を表示（締切に最も近い）

### 例2: レース終了後（18:00以降）

**すべてのレース**:
```
1R: 08:47 (終了)
2R: 09:17 (終了)
...
12R: 16:30 (終了)
```

**結果**: 12R を表示（前日の最終レース）

---

## 🔧 トラブルシューティング

### 締切時刻が取得できない場合

**症状**: コンソールに「Schedule not available, using fallback logic」と表示

**原因**:
1. BOATRACE公式サイトのHTML構造が変更された
2. レース開催日でない
3. Worker が古いバージョン

**対処**:
1. Worker の再デプロイ
2. `test-race-schedule.html` で詳細確認
3. HTML構造が変わっていればパース処理を修正

### 古いレースが表示される

**症状**: 締切済みのレースが表示される

**原因**: ブラウザのキャッシュ、または自動更新が停止

**対処**:
1. ブラウザをハードリフレッシュ（Ctrl+Shift+R / Cmd+Shift+R）
2. 「今すぐ更新」ボタンをクリック
3. 8:00-18:00の時間帯か確認（その時間帯のみ5分おき自動更新）

---

## 📊 パフォーマンス

### API呼び出し回数

**従来**:
- 各場で推定レース ± 2 + フォールバックで最大15回試行
- 24場 × 15 = 最大360リクエスト

**新方式**:
- 各場でスケジュール取得1回 + オッズ取得1回 = 2回
- 24場 × 2 = 48リクエスト

**改善率**: 約88%削減 🎉

---

## 🎊 完了！

全ての実装が完了しました。以下の手順で確認してください：

1. **Worker 再デプロイ**
2. **test-race-schedule.html でテスト**
3. **index.html で実際の動作確認**

問題があれば、ブラウザコンソール（F12）でエラーログを確認してください。

---

## 📁 更新ファイル一覧

- ✅ `worker.js` - 締切時刻取得エンドポイント追加
- ✅ `js/main.js` - レース選択ロジック完全書き換え
- ✅ `test-race-schedule.html` - テストページ
- ✅ `README.md` - 機能説明更新
- ✅ `RACE_SCHEDULE_COMPLETE.md` - 本ドキュメント

**Worker を再デプロイして、test-race-schedule.html でテストしてください！** 🚀
