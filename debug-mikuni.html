<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å›½ï¼ˆ10ï¼‰ãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ä¸‰å›½ï¼ˆ10ï¼‰ãƒ‡ãƒãƒƒã‚° - 2/18é–‹å‚¬</h1>
    
    <div class="section">
        <h2>Step 1: ãƒ¬ãƒ¼ã‚¹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºèª</h2>
        <button onclick="checkSchedule()">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å–å¾—</button>
        <div id="scheduleResult"></div>
    </div>
    
    <div class="section">
        <h2>Step 2: 12Rã‚ªãƒƒã‚ºç¢ºèª</h2>
        <button onclick="checkOdds()">12Rã‚ªãƒƒã‚ºå–å¾—</button>
        <div id="oddsResult"></div>
    </div>
    
    <div class="section">
        <h2>Step 3: å…¬å¼ã‚µã‚¤ãƒˆç¢ºèª</h2>
        <p>ä»¥ä¸‹ã®URLã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã„ã¦ç¢ºèªã—ã¦ãã ã•ã„ï¼š</p>
        <ul>
            <li><a href="https://www.boatrace.jp/owpc/pc/race/raceindex?jcd=10&hd=20260218" target="_blank">ãƒ¬ãƒ¼ã‚¹ä¸€è¦§ï¼ˆraceindexï¼‰</a></li>
            <li><a href="https://www.boatrace.jp/owpc/pc/race/oddstf?jcd=10&rno=12&hd=20260218" target="_blank">12Rã‚ªãƒƒã‚ºï¼ˆoddstfï¼‰</a></li>
        </ul>
    </div>
    
    <div class="section">
        <h2>Step 4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‹•ä½œç¢ºèª</h2>
        <button onclick="checkFrontend()">ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ</button>
        <div id="frontendResult"></div>
    </div>
    
    <script>
        const API_BASE = 'https://boatrace.shinta7023.workers.dev';
        const JCD = '10'; // ä¸‰å›½
        const TEST_DATE = '20260218';
        
        async function checkSchedule() {
            const resultDiv = document.getElementById('scheduleResult');
            resultDiv.innerHTML = '<p>å–å¾—ä¸­...</p>';
            
            try {
                const url = `${API_BASE}/api/race-schedule/${JCD}?hd=${TEST_DATE}`;
                console.log('Fetching:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Schedule data:', data);
                
                let html = '<div class="result ' + (data.success && data.data.hasSchedule ? 'success' : 'error') + '">';
                html += `<strong>URL:</strong> ${url}<br>`;
                html += `<strong>success:</strong> ${data.success}<br>`;
                html += `<strong>hasSchedule:</strong> ${data.data?.hasSchedule}<br>`;
                
                if (data.data?.hasSchedule && data.data.races) {
                    html += `<strong>ãƒ¬ãƒ¼ã‚¹æ•°:</strong> ${data.data.races.length}<br>`;
                    html += `<strong>ãƒ¬ãƒ¼ã‚¹ä¸€è¦§:</strong> ${data.data.races.map(r => r.raceNumber + 'R(' + r.limitTime + ')').join(', ')}<br>`;
                } else {
                    html += `<strong style="color: red;">âš ï¸ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãªã—</strong><br>`;
                }
                
                html += '</div>';
                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                console.error(error);
            }
        }
        
        async function checkOdds() {
            const resultDiv = document.getElementById('oddsResult');
            resultDiv.innerHTML = '<p>å–å¾—ä¸­...</p>';
            
            try {
                const url = `${API_BASE}/api/odds/${JCD}/12?hd=${TEST_DATE}`;
                console.log('Fetching:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Odds data:', data);
                
                let html = '<div class="result ' + (data.success && data.data.hasRace ? 'success' : 'error') + '">';
                html += `<strong>URL:</strong> ${url}<br>`;
                html += `<strong>success:</strong> ${data.success}<br>`;
                html += `<strong>hasRace:</strong> ${data.data?.hasRace}<br>`;
                
                if (data.data?.hasRace && data.data.odds) {
                    html += `<strong>ã‚ªãƒƒã‚ºæ•°:</strong> ${data.data.odds.length}<br>`;
                    html += `<strong>1å·è‰‡:</strong> ${data.data.odds[0].oddsMin}ã€œ${data.data.odds[0].oddsMax}<br>`;
                } else {
                    html += `<strong style="color: red;">âš ï¸ ã‚ªãƒƒã‚ºãƒ‡ãƒ¼ã‚¿ãªã—</strong><br>`;
                }
                
                html += '</div>';
                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                console.error(error);
            }
        }
        
        async function checkFrontend() {
            const resultDiv = document.getElementById('frontendResult');
            resultDiv.innerHTML = '<p>å®Ÿè¡Œä¸­...</p>';
            
            try {
                // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œ
                const now = new Date();
                const jstOffset = 9 * 60 * 60 * 1000;
                const jstTime = new Date(now.getTime() + jstOffset);
                const hours = jstTime.getUTCHours();
                const jstDate = jstTime.toISOString().slice(0, 10).replace(/-/g, '');
                
                let targetDate, showOnlyRace12;
                
                if (hours >= 0 && hours < 8) {
                    const yesterday = new Date(jstTime);
                    yesterday.setUTCDate(yesterday.getUTCDate() - 1);
                    targetDate = yesterday.toISOString().slice(0, 10).replace(/-/g, '');
                    showOnlyRace12 = true;
                } else if (hours >= 23) {
                    targetDate = jstDate;
                    showOnlyRace12 = true;
                } else {
                    targetDate = jstDate;
                    showOnlyRace12 = false;
                }
                
                let html = '<div class="result">';
                html += `<strong>ç¾åœ¨JSTæ™‚åˆ»:</strong> ${jstTime.toISOString()}<br>`;
                html += `<strong>JSTæ™‚:</strong> ${hours}æ™‚<br>`;
                html += `<strong>targetDate:</strong> ${targetDate}<br>`;
                html += `<strong>showOnlyRace12:</strong> ${showOnlyRace12}<br>`;
                html += '</div>';
                
                // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å–å¾—
                const scheduleUrl = `${API_BASE}/api/race-schedule/${JCD}?hd=${targetDate}`;
                const scheduleRes = await fetch(scheduleUrl);
                const scheduleData = await scheduleRes.json();
                
                html += '<div class="result ' + (scheduleData.success && scheduleData.data.hasSchedule ? 'success' : 'error') + '">';
                html += `<strong>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:</strong> ${scheduleData.data?.hasSchedule ? 'ã‚ã‚Š' : 'ãªã—'}<br>`;
                
                if (scheduleData.success && scheduleData.data.hasSchedule && scheduleData.data.races) {
                    const races = scheduleData.data.races;
                    html += `<strong>ãƒ¬ãƒ¼ã‚¹æ•°:</strong> ${races.length}<br>`;
                    
                    if (showOnlyRace12) {
                        html += `<strong>é¸æŠãƒ¬ãƒ¼ã‚¹:</strong> 12Rï¼ˆå¼·åˆ¶ï¼‰<br>`;
                    } else {
                        const now = Date.now();
                        const upcomingRaces = races.filter(r => r.limitTimestamp > now);
                        
                        if (upcomingRaces.length === 0) {
                            html += `<strong>é¸æŠãƒ¬ãƒ¼ã‚¹:</strong> 12Rï¼ˆå…¨çµ‚äº†ï¼‰<br>`;
                        } else {
                            upcomingRaces.sort((a, b) => a.limitTimestamp - b.limitTimestamp);
                            const bestRace = upcomingRaces[0];
                            html += `<strong>é¸æŠãƒ¬ãƒ¼ã‚¹:</strong> ${bestRace.raceNumber}Rï¼ˆç· åˆ‡: ${bestRace.limitTime}ï¼‰<br>`;
                        }
                    }
                    
                    html += `<strong>çµè«–:</strong> <span style="color: green; font-weight: bold;">ä¸‰å›½ã¯è¡¨ç¤ºã•ã‚Œã‚‹ã¹ã</span><br>`;
                } else {
                    html += `<strong>çµè«–:</strong> <span style="color: red; font-weight: bold;">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå–å¾—ã§ããªã„ãŸã‚è¡¨ç¤ºã•ã‚Œãªã„</span><br>`;
                }
                
                html += '</div>';
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                console.error(error);
            }
        }
    </script>
</body>
</html>
